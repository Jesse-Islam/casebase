---
title: "Plot Hazards, Hazard Ratios"
author: "Sahir Rai Bhatnagar"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_height: 8
    fig_width: 11
    toc: yes
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{Plot Hazards and Hazard Ratios}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
bibliography: reference.bib
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


# German Breast Cancer Study Group 2

This data frame contains the observations of 686 women from the `TH.data` package. This dataset is also available from the `rstpm2` package. 

## One binary predictor, no interactions

```{r}
pacman::p_load(rstpm2) # for brcancer data
pacman::p_load(TH.data) # same as brcancer data but with proper names
pacman::p_load(splines)
devtools::load_all("~/git_repositories/casebase/")
pacman::p_load(visreg)

# data("brcancer")
# factoring hormon, breaks the plot method for rstpm2 with interactions!!!
# brcancer <- transform(brcancer, hormon=factor(hormon, levels = 0:1, labels = c("no","yes")))
data("GBSG2")

GBSG2 <- transform(GBSG2, hormon=as.numeric(GBSG2$horTh)-1)
GBSG2 <- transform(GBSG2, meno=as.numeric(GBSG2$menostat)-1)


# str(GBSG2)
# str(brcancer)
# head(GBSG2)


mod_cb <- fitSmoothHazard(cens ~ nsx(log(time), df = 3) + hormon,
                          data = GBSG2,
                          time = "time")
mod_rstpm2 <- rstpm2::stpm2(Surv(time,cens == 1) ~ hormon,
                            data = GBSG2, df = 3)
summary(mod_cb)
summary(mod_rstpm2)
```

### Hazard functions on separate plots

```{r}
par(mfrow = c(2,2))
plot(mod_cb,
     hazard.params = list(xvar = c("time"),
                          cond = list(hormon = 0),
                          alpha = 0.05,
                          main = "Casebase: No Hormonal Therapy"))

plot(mod_rstpm2,
     newdata = data.frame(hormon = 0),
     type = "hazard", 
     main = "rstmp2: No Hormonal Therapy")

plot(mod_cb,
     hazard.params = list(xvar = c("time"),
                          cond = list(hormon = 1),
                          alpha = 0.05,
                          main = "Casebase: Hormonal Therapy"))

plot(mod_rstpm2,
     newdata = data.frame(hormon = 1),
     type = "hazard", 
     main = "rstmp2: Hormonal Therapy")
```



### Hazard functions on same plots

We can already see the advantage and power of using `visreg`. We can easily plot two curves on the same graph, have the confidence bands somewhat transparent, and y-axis limits are adjusted automatically. This is difficult to do otherwise. 

```{r}
par(mfrow = c(1,2))
plot(mod_cb,
     hazard.params = list(xvar = c("time"),
                          by = "hormon",
                          alpha = 0.05,
                          ylab = "Hazard")) 

plot(mod_rstpm2,
     newdata = data.frame(hormon = 0),
     type = "hazard", 
     main = "rstmp2")
plot(mod_rstpm2,
     newdata = data.frame(hormon = 1),
     type = "hazard", 
     main = "rstmp2",
     add = TRUE,ci = TRUE)

```

### ggplot2 version 

It's also flexible because we can leverage the `ggplot2` just by specifying `gg=TRUE`, the plot will return a `ggplot` object:

```{r}
gg_object <- plot(mod_cb,
                  hazard.params = list(xvar = c("time"),
                                       by = "hormon",
                                       alpha = 0.20, # 80% CI
                                       ylab = "Hazard",
                                       gg = TRUE)) 

attr(gg_object,"class")
```

Now we can use it downstream for any plot while leveraging the entire ggplot2 ecosystem of packages and functions:

```{r}
gg_object + 
  ggthemes::theme_solarized()+
  theme(legend.position = "bottom") + 
  labs(title = "Casebase") + 
  scale_y_continuous(labels = scales::label_number()) + 
  scale_x_continuous(n.breaks = 10)
```


## One binary predictor with interaction

```{r}
mod_cb_tvc <- fitSmoothHazard(cens ~ hormon*nsx(log(time), df = 3),
                              data = GBSG2,
                              time = "time")
mod_rstpm2_tvc <- rstpm2::stpm2(Surv(time,cens == 1) ~ hormon,
                                data = GBSG2, df = 3,
                                tvc=list(hormon = 3))

summary(mod_cb_tvc)
summary(mod_rstpm2_tvc)


par(mfrow = c(1,2))
plot(mod_cb_tvc,
     hazard.params = list(xvar = c("time"),
                          by = "hormon",
                          alpha = 0.05,
                          ylab = "Hazard")) 

plot(mod_rstpm2_tvc,
     newdata = data.frame(hormon = 0),
     type = "hazard", var = "hormon")
plot(mod_rstpm2_tvc,
     newdata = data.frame(hormon = 1),
     type = "hazard", var = "hormon", add = TRUE, ci = TRUE)

```


## One continuous predictor with interaction


```{r}
mod_cb_tvc <- fitSmoothHazard(cens ~ estrec*nsx(log(time), df = 3),
                              data = GBSG2,
                              time = "time")
summary(mod_cb_tvc)

par(mfrow = c(1,3))
# copmuted at the 10th, 50th and 90th quantiles of estrec
plot(mod_cb_tvc,
     hazard.params = list(xvar = c("time"),
                          by = "estrec",
                          alpha = 1,
                          ylab = "Hazard")) 


# copmuted at quartiles of estrec
plot(mod_cb_tvc,
     hazard.params = list(xvar = c("time"),
                          by = "estrec",
                          alpha = 1,
                          breaks = 2,
                          ylab = "Hazard")) 

# computed where I want
plot(mod_cb_tvc,
     hazard.params = list(xvar = c("time"),
                          by = "estrec",
                          alpha = 1,
                          breaks = c(3,2200),
                          ylab = "Hazard")) 
```

### Image and Perspective Plots

```{r}
visreg2d(mod_cb_tvc, 
         xvar = "time",
         yvar = "estrec",
         trans = exp,
         print.cond = TRUE,
         zlab = "Hazard",
         plot.type = "image")

visreg2d(mod_cb_tvc, 
         xvar = "time",
         yvar = "estrec",
         trans = exp,
         print.cond = TRUE,
         zlab = "Hazard",
         plot.type = "persp")

visreg2d(mod_cb_tvc, 
         xvar = "time",
         yvar = "estrec",
         trans = exp,
         print.cond = TRUE,
         zlab = "Hazard",
         plot.type = "rgl")
```


## One continuous predictor with interaction and several other predictors

We know clearly what the value of the variables are in the Hazard function plot:

```{r}
mod_cb_tvc <- fitSmoothHazard(cens ~ estrec*nsx(log(time), df = 3) + 
                                horTh + 
                                age + 
                                menostat + 
                                tsize + 
                                tgrade + 
                                pnodes + 
                                progrec,
                              data = GBSG2,
                              time = "time")
summary(mod_cb_tvc)


plot(mod_cb_tvc,
     hazard.params = list(xvar = c("time"),
                          by = c("estrec"),
                          alpha = 1,
                          breaks = 2,
                          ylab = "Hazard")) 

# plot each variable's effect on Hazard
par(mfrow = c(2,4))
plot(mod_cb_tvc,
     hazard.params = list(alpha = 1,
                          ylab = "Hazard")) 
```

